{% extends '_base.html' %}
{% csrf_token %}

{% block title %}
	Post Detail
{% endblock %}

{% block extra_head %}

{% endblock %}


{% block content %}
    {% csrf_token %}
<div class="min-h-screen bg-gray-900 flex flex-col items-center py-10 text-gray-100">
  <!-- Main Container -->
  <div class="w-11/12 max-w-5xl bg-gray-800 rounded-lg shadow-lg overflow-hidden">
    <div class="flex flex-col lg:flex-row">
      <!-- Image Section -->
      <div class="w-full lg:w-2/3 p-4">
        <img id="main-post-image" src="https://via.placeholder.com/600x400" alt="Post Image" class="rounded-lg mb-4 hidden">
        <div id="post-images" class="grid grid-cols-3 gap-2">

          <!-- Images populated dynamically -->
        </div>
      </div>

      <!-- Details Section -->
      <div class="w-full lg:w-1/3 bg-gray-700 p-6 text-right">
          <div class="flex flex-row">

            <h1 id="post-title" class="text-2xl font-bold mb-4">عنوان آگهی</h1>
            <div class="flex items-center justify-center w-8 max-h-8 z-50 mr-4">
             <!-- Heart Button -->
             <button
               id="heartButton"
               class="p-3 rounded-full hover:scale-110 transition-all duration-300 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-pink-300"
             >
               <!-- SVG Icon -->
               <svg
                 id="heartIcon"
                 xmlns="http://www.w3.org/2000/svg"
                 class="w-8 h-8 text-gray-400 transition-colors duration-300"
                 viewBox="0 0 24 24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round"
               >
                 <path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0l-1 1-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"></path>
               </svg>
             </button>
          </div>
          </div>

        <ul class="text-gray-300 mb-6">
          <li id="category-title" class="mb-2 font-semibold">دسته‌بندی: در حال بارگذاری...</li>
          <li id="created-at-date" class="mb-2">تاریخ ایجاد: در حال بارگذاری...</li>
        </ul>

        <div id="fields-container" class="mb-4 hidden">
          <h2 class="text-lg font-bold text-gray-200 mb-2">ویژگی‌ها</h2>
          <ul id="fields-list" class="text-gray-300">
            <!-- Fields populated dynamically -->
          </ul>
        </div>

        <button id="contact-button" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-semibold transition">
          اطلاعات تماس
        </button>

        <div class="mt-6">
          <h2 class="text-lg font-bold text-gray-200 mb-2">توضیحات</h2>
          <p id="post-description" class="text-sm leading-relaxed">
            در حال بارگذاری...
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Info Section -->
  <div id="contact-info" class="hidden w-11/12 max-w-5xl bg-gray-800 rounded-lg shadow-lg mt-6 p-6 text-right">
    <h2 class="text-xl font-bold text-gray-200 mb-4">اطلاعات تماس</h2>
    <p id="contact-name" class="text-gray-300 mb-2">نام: در حال بارگذاری...</p>
    <p id="contact-email" class="text-gray-300">ایمیل: در حال بارگذاری...</p>
  </div>
</div>

{% endblock %}


{% block extra_body %}


<script>

    const csrftoken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    const postId = {{ id }};
    const postDetailUrl = `http://localhost:8000/post/api/post_detail/${postId}`;
    const postOwnerUrl = `http://localhost:8000/post/api/post_detail/${postId}/owner`;



    async function fetchPostDetails() {
    try {
      const response = await fetch(postDetailUrl, { method: "GET" });

      if (!response.ok) {
        throw new Error(`Failed to fetch post details: ${response.status}`);
      }

      const data = await response.json();

      document.getElementById("post-title").textContent = data.title;
      document.getElementById("post-description").textContent = data.description;
      document.getElementById("category-title").textContent = data.category.title;
      document.getElementById("created-at-date").textContent = `تاریخ ایجاد: ${new Date(
        data.created_at
      ).toLocaleString("fa-IR")}`;

      if (data.fields && data.fields.length > 0) {
        const fieldsContainer = document.getElementById("fields-container");
        const fieldsList = document.getElementById("fields-list");

        fieldsContainer.classList.remove("hidden");
        fieldsList.innerHTML = "";

        data.fields.forEach((field) => {
          if (field.value) {
            const fieldDefinition = data.category.fields.find(
              (categoryField) => categoryField.id === field.field_id
            );
            if (fieldDefinition) {
              const li = document.createElement("li");
              li.textContent = `${fieldDefinition.name}: ${field.value}`;
              fieldsList.appendChild(li);
            }
          }
        });
      }

        const imagesContainer = document.getElementById("post-images");
        const mainImage = document.getElementById("main-post-image");
        imagesContainer.innerHTML = "";

        let coverImageSrc = null;


        const coverImage = data.images.find((image) => image.is_cover);

        if (coverImage) {
          coverImageSrc = coverImage.image;
          mainImage.src = coverImage.image;
          mainImage.alt = coverImage.caption || "تصویر کاور آگهی";
          mainImage.classList.remove("hidden");
        } else {
          mainImage.classList.add("hidden");
        }


        data.images.forEach((image) => {
          if (coverImage && image.image === coverImage.image) return;

          const imgElement = document.createElement("img");
          imgElement.src = image.image;
          imgElement.alt = image.caption || "تصویر آگهی";
          imgElement.className =
            "w-full h-auto rounded shadow cursor-pointer transition-transform hover:scale-105";
          imgElement.addEventListener("click", () => {
            mainImage.src = image.image;
            mainImage.alt = image.caption || "تصویر آگهی";
          });
          imagesContainer.appendChild(imgElement);
        });

        mainImage.addEventListener("click", () => {
          if (coverImageSrc) {
            mainImage.src = coverImageSrc;
            mainImage.alt = "تصویر کاور آگهی";
          }
        });

    } catch (error) {
      console.error("Failed to fetch post details:", error);
    }
  }


  async function fetchPostOwner() {
    try {
      const response = await fetchWithAuth(postOwnerUrl, { method: "GET" });
      if (!response.ok) {

      }

      const data = response;

      document.getElementById("contact-name").textContent = `نام: ${
        data.user.first_name || "نامشخص"
      } ${data.user.last_name || ""}`;
      document.getElementById("contact-email").textContent = `ایمیل: ${
        data.user.email || "نامشخص"
      }`;

      document.getElementById("contact-info").classList.remove("hidden");
    } catch (error) {
      console.error("Failed to fetch post owner info:", error);
    }
  }

  document.getElementById("contact-button").addEventListener("click", () => {
    fetchPostOwner();
  });

  fetchPostDetails();

   const heartButton = document.getElementById("heartButton");
  const heartIcon = document.getElementById("heartIcon");
    let isLiked = false

  heartButton.addEventListener("click", () => {

      toggleFavorite(postId)

    isLiked = !isLiked;

    if (isLiked) {
      // Toggle to liked (filled heart)
      heartIcon.setAttribute("fill", "currentColor");
      heartIcon.classList.replace("text-gray-400", "text-pink-500");
    } else {
      // Toggle to unliked (hollow heart)
      heartIcon.setAttribute("fill", "none");
      heartIcon.classList.replace("text-pink-500", "text-gray-400");
    }
  });

      async function toggleFavorite(button) {

        try {
          const response = await fetchWithAuth('http://localhost:8000/bookmarks/bookmarks/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ posts: postId }),
          });

            const result = await response
            console.error('Failed to toggle favorite:', await response);

        } catch (error) {
          console.error('Error toggling favorite:', error);
        }
      }

      async function CheckFavorite() {

        try {
          const response = await fetchWithAuth(`http://localhost:8000/bookmarks/bookmarks?post=${postId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          });

            const result = await response
            console.log(result.exists)
            if (result.exists == false){
                console.log("No likes")




            }else{
                console.log("liked it")
                                isLiked = !isLiked;
                heartIcon.setAttribute("fill", "currentColor");
                heartIcon.classList.replace("text-gray-400", "text-pink-500")
            }

        } catch (error) {
          console.error('Error toggling favorite:', error);
        }
      }
        CheckFavorite()

</script>

{% endblock %}