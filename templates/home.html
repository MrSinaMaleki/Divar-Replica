{% extends '_base.html' %}
{% csrf_token %}

{% block title %}
	Post Listing
{% endblock %}

{% block extra_head %}

{% endblock %}


{% block content %}
    {% csrf_token %}

<div id="app" class="max-w-7xl mx-auto mt-6">
    <div id="posts" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Posts will be rendered here -->
    </div>
  </div>

{% endblock %}


{% block extra_body %}

 <script>
        async function fetchPosts() {
      try {
        const response = await fetch('http://localhost:8000/post/api/all_posts');
        const data = await response.json();

        const postsContainer = document.getElementById('posts');

        data.forEach(post => {
          const coverImage = post.images.find(img => img.is_cover)?.image || 'https://via.placeholder.com/150';
          const ladderedClass = post.laddered
            ? 'bg-red-200 border-red-500 relative'
            : 'bg-white border';
          const ladderedBadge = post.laddered
            ? `<span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded">پله شده</span>`
            : '';

          // Convert to Persian date
          const persianDate = new Intl.DateTimeFormat('fa-IR', { dateStyle: 'long', timeStyle: 'short' }).format(new Date(post.created_at));

          const postHTML = `
            <div onclick="showpostinfo(${post.id})" class="cursor-pointer shadow-lg rounded-lg overflow-hidden border ${ladderedClass}">
              ${ladderedBadge}
              <img src="${coverImage}" alt="${post.title}" class="w-full h-48 object-cover">
              <div class="p-4">
                <h2 class="text-lg font-bold">${post.title}</h2>
                <p class="text-gray-600 text-sm">${post.description}</p>
                <p class="text-gray-400 text-xs mt-2">تاریخ: ${persianDate}</p>
              </div>
            </div>
          `;
          postsContainer.innerHTML += postHTML;
        });
      } catch (error) {
        console.error('Error fetching posts:', error);
        document.getElementById('posts').innerHTML = `<p class="text-red-500">مشکلی در بارگذاری پست‌ها وجود دارد</p>`;
      }
    }

    // Empty function for onClick
    function showpostinfo(postId) {
      location.replace(`http://localhost:8000/post/post_detail/${postId}`)
      // Function body to be implemented later
    }

    // Fetch posts on page load
    fetchPosts();
  </script>

{% endblock %}
